<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ai-or-die</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="ai-or-die - Multi-tool AI coding assistant in your browser">
    <meta name="theme-color" content="#161b22">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ai-or-die">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ai-or-die">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons for various platforms -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-180.png">
    <meta name="msapplication-TileColor" content="#161b22">
    <meta name="msapplication-TileImage" content="/icon-144.png">
    
    <!-- Apply saved theme early to avoid flash -->
    <script>
      (function() {
        try {
          const s = JSON.parse(localStorage.getItem('cc-web-settings') || '{}');
          if (s && s.theme && s.theme !== 'midnight') {
            document.documentElement.setAttribute('data-theme', s.theme);
          } else {
            // Midnight is default â€” no data-theme attribute needed
            document.documentElement.removeAttribute('data-theme');
          }
        } catch (_) { /* ignore */ }
      })();
    </script>
    <link rel="preload" href="fonts/MesloLGSNerdFont-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="fonts/MesloLGSNerdFont-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="tokens.css">
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="components/tabs.css">
    <link rel="stylesheet" href="components/terminal.css">
    <link rel="stylesheet" href="components/buttons.css">
    <link rel="stylesheet" href="components/modals.css">
    <link rel="stylesheet" href="components/cards.css">
    <link rel="stylesheet" href="components/menus.css">
    <link rel="stylesheet" href="components/notifications.css">
    <link rel="stylesheet" href="components/file-browser.css">
    <link rel="stylesheet" href="components/vscode-tunnel.css">
    <link rel="stylesheet" href="components/voice-input.css">
    <link rel="stylesheet" href="mobile.css">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://unpkg.com/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script src="https://unpkg.com/xterm-addon-search@0.13.0/lib/xterm-addon-search.js"></script>
    <script src="https://unpkg.com/xterm-addon-unicode11@0.6.0/lib/xterm-addon-unicode11.js"></script>
    <script src="https://unpkg.com/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.js"></script>
    <script src="https://unpkg.com/xterm-addon-canvas@0.5.0/lib/xterm-addon-canvas.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.36.5/ace.min.js" as="script">
</head>
<body>
    <a href="#terminal" class="skip-to-content">Skip to terminal</a>
    <div id="app" role="application" aria-label="ai-or-die terminal interface">
        <!-- Live region for screen reader announcements -->
        <div id="srAnnounce" class="sr-only" aria-live="polite" aria-atomic="true"></div>

        <!-- Session Tabs Bar -->
        <div class="session-tabs-bar" id="sessionTabsBar" data-tid="session-tabs-bar">
            <div class="tabs-section">
                <div class="tabs-container" id="tabsContainer" data-tid="tabs-container">
                    <!-- Tabs will be dynamically added here -->
                </div>
                <div class="tab-new-split">
                    <button class="tab-new-main" id="tabNewBtn" title="Quick New Session (Ctrl+T)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                    <button class="tab-new-dropdown" id="tabNewDropdown" title="New Session Options...">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Overflow dropdown for mobile - outside tabs-section to prevent scrolling issues -->
            <div class="tab-overflow-wrapper" id="tabOverflowWrapper" style="display: none;">
                <button class="tab-overflow-btn" id="tabOverflowBtn" title="More tabs">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                    </svg>
                    <span class="tab-overflow-count">0</span>
                </button>
                <div class="tab-overflow-menu" id="tabOverflowMenu">
                    <!-- Overflow tabs will be listed here -->
                </div>
            </div>
            <div class="tab-actions">
                <button class="tab-browse-files" id="browseFilesBtn" title="Browse Files (Ctrl+B)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        <line x1="9" y1="14" x2="15" y2="14"/>
                    </svg>
                </button>
                <button class="tab-app-tunnel" id="appTunnelBtn" title="App Tunnel" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                </button>
                <button class="tab-vscode-tunnel" id="vscodeTunnelBtn" title="VS Code Tunnel (Ctrl+Shift+V)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                </button>
                <button class="tab-attach-image" id="attachImageBtn" title="Attach Image">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </button>
                <button class="tab-voice-input" id="voiceInputBtn" title="Voice Input (Ctrl+Shift+M)" style="display: none;" aria-label="Voice Input" aria-pressed="false">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                    <span class="voice-timer" style="display: none;">0:00</span>
                </button>
                <button class="tab-settings" id="settingsBtn" title="Settings">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                </svg>
                </button>
            </div>
        </div>

        <div class="app-tunnel-banner" id="appTunnelBanner"></div>
        <div class="vscode-tunnel-banner" id="vscodeTunnelBanner"></div>
        <div class="voice-download-banner" id="voiceDownloadBanner" style="display: none;">
            <span class="voice-download-icon">&#11015;</span>
            <span class="voice-download-text">Downloading speech recognition model (670 MB)...</span>
            <div class="voice-download-progress"><div class="voice-download-fill" id="voiceDownloadFill"></div></div>
            <span class="voice-download-percent" id="voiceDownloadPercent">0%</span>
            <button class="voice-download-dismiss" id="voiceDownloadDismiss">&times;</button>
        </div>

        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h2><span class="icon" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="4"/><path d="M8 10h.01M16 10h.01M8 16c1.333-1 2.667-1 4 0 1.333 1 2.667 1 4 0"/></svg></span> <span id="mobileMenuTitle">ai-or-die</span></h2>
                <button class="close-menu-btn" id="closeMenuBtn" aria-label="Close menu">&times;</button>
            </div>
            <div class="mobile-menu-content">
                <button id="sessionsBtnMobile" class="mobile-menu-btn">Sessions</button>
                <button id="closeSessionBtnMobile" class="mobile-menu-btn btn-danger" style="display: none;">Close Session</button>
                <button id="reconnectBtnMobile" class="mobile-menu-btn" disabled>Reconnect</button>
                <button id="clearBtnMobile" class="mobile-menu-btn">Clear Terminal</button>
                <button id="settingsBtnMobile" class="mobile-menu-btn">Settings</button>
            </div>
        </div>

        <main class="main">
            <div class="terminal-container" id="terminalContainer" data-view="single">
                <div class="terminal-search-bar" id="terminalSearchBar" style="display:none" data-tid="search-bar">
                    <input type="text" id="termSearchInput" class="term-search-input" placeholder="Search terminal..." autocomplete="off" spellcheck="false">
                    <span class="term-search-count" id="termSearchCount"></span>
                    <button class="term-search-btn" id="termSearchPrev" title="Previous (Shift+Enter)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
                    </button>
                    <button class="term-search-btn" id="termSearchNext" title="Next (Enter)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <button class="term-search-btn term-search-toggle" id="termSearchCase" title="Match Case">Aa</button>
                    <button class="term-search-btn term-search-toggle" id="termSearchRegex" title="Regex">.*</button>
                    <button class="term-search-btn" id="termSearchClose" title="Close (Escape)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>
                <div class="terminal-wrapper">
                    <div id="terminal" data-tid="terminal"></div>
                </div>
            </div>
            <!-- Context menu shared by main terminal and split panes -->
            <div id="termContextMenu" class="term-context-menu" style="display:none" role="menu" data-tid="context-menu">
                <div class="ctx-item" data-action="copy" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span>
                    <span>Copy</span><span class="shortcut">Ctrl+C</span>
                </div>
                <div class="ctx-item" data-action="paste" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg></span>
                    <span>Paste</span><span class="shortcut">Ctrl+V</span>
                </div>
                <div class="ctx-item" data-action="pastePlain" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/><line x1="8" y1="12" x2="16" y2="12"/></svg></span>
                    <span>Paste as Plain Text</span>
                </div>
                <div class="ctx-item" data-action="pasteImage" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></span>
                    <span>Paste Image</span>
                </div>
                <div class="ctx-sep" role="separator"></div>
                <div class="ctx-item" data-action="attachImage" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></span>
                    <span>Attach Image...</span>
                </div>
                <div class="ctx-sep" role="separator"></div>
                <div class="ctx-item" data-action="selectAll" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 12h8"/><path d="M8 8h8"/><path d="M8 16h8"/></svg></span>
                    <span>Select All</span>
                </div>
                <div class="ctx-item" data-action="clear" role="menuitem" tabindex="-1">
                    <span class="ctx-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M5 6v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6"/></svg></span>
                    <span>Clear</span>
                </div>
            </div>
        </main>

        <!-- App-wide overlay (moved out of terminal container to avoid width issues) -->
        <div class="terminal-overlay" id="overlay" style="display: none;" data-tid="overlay">
            <div class="overlay-content">
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Connecting to Claude Code...</p>
                </div>
                <div class="start-prompt" id="startPrompt" style="display: none;" data-tid="start-prompt">
                    <h2 class="start-prompt-heading">Choose Your Assistant</h2>
                    <p class="start-prompt-subtitle">Pick an AI coding assistant or open a terminal to get started.</p>
                    <div id="toolCards" class="tool-cards-list" role="group" aria-label="Available assistants" data-tid="tool-cards">
                        <!-- Tool cards will be dynamically generated by app.js -->
                    </div>
                </div>
                <div class="error-message" id="errorMessage" style="display: none;">
                    <h3>Connection Error</h3>
                    <p id="errorText"></p>
                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px;">
                        <button id="retryBtn" class="btn btn-primary">Retry Connection</button>
                        <button class="btn btn-secondary" onclick="location.reload()">Refresh Page</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-modal" id="settingsModal" role="dialog" aria-modal="true" aria-label="Settings">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="close-btn" id="closeSettingsBtn" aria-label="Close settings">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="setting-section" data-section="terminal">
                        <div class="setting-section-header">Terminal</div>
                        <div class="setting-section-content">
                            <div class="setting-group">
                                <label for="themeSelect">Theme:</label>
                                <select id="themeSelect">
                                    <option value="midnight">Midnight</option>
                                    <option value="classic-dark">Classic Dark</option>
                                    <option value="classic-light">Classic Light</option>
                                    <option value="monokai">Monokai</option>
                                    <option value="nord">Nord</option>
                                    <option value="solarized-dark">Solarized Dark</option>
                                    <option value="solarized-light">Solarized Light</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="fontFamily">Font:</label>
                                <select id="fontFamily">
                                    <option value="'MesloLGS Nerd Font', 'MesloLGS NF', 'Meslo Nerd Font', monospace">Meslo Nerd Font</option>
                                    <option value="'JetBrains Mono NF', 'MesloLGS Nerd Font', monospace">JetBrains Mono</option>
                                    <option value="'Fira Code NF', 'MesloLGS Nerd Font', monospace">Fira Code</option>
                                    <option value="'Cascadia Code NF', 'MesloLGS Nerd Font', monospace">Cascadia Code</option>
                                    <option value="'Consolas', 'MesloLGS Nerd Font', monospace">Consolas</option>
                                    <option value="'MesloLGS Nerd Font', monospace">System Monospace</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="fontSize">Font Size:</label>
                                <input type="range" id="fontSize" min="10" max="24" value="14">
                                <span id="fontSizeValue">14px</span>
                            </div>
                            <div class="setting-group">
                                <label for="cursorStyle">Cursor:</label>
                                <select id="cursorStyle">
                                    <option value="block">Block</option>
                                    <option value="underline">Underline</option>
                                    <option value="bar">Bar</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="cursorBlink">Cursor Blink:</label>
                                <input type="checkbox" id="cursorBlink" checked>
                            </div>
                            <div class="setting-group">
                                <label for="scrollback">Scrollback:</label>
                                <select id="scrollback">
                                    <option value="1000">1,000 lines</option>
                                    <option value="5000">5,000 lines</option>
                                    <option value="10000">10,000 lines</option>
                                    <option value="50000">50,000 lines</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="terminalPadding">Padding:</label>
                                <input type="range" id="terminalPadding" min="0" max="20" value="8">
                                <span id="terminalPaddingValue">8px</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section" data-section="voice">
                        <div class="setting-section-header">Voice Input</div>
                        <div class="setting-section-content">
                            <div class="setting-group">
                                <label for="voiceRecordingMode">Recording Mode:</label>
                                <select id="voiceRecordingMode">
                                    <option value="push-to-talk">Push-to-Talk</option>
                                    <option value="toggle">Toggle</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="voiceMethod">Input Method:</label>
                                <select id="voiceMethod">
                                    <option value="auto">Auto</option>
                                    <option value="cloud">Cloud</option>
                                    <option value="local">Local</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="micSounds">Mic Sounds:</label>
                                <input type="checkbox" id="micSounds" checked>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section" data-section="notifications">
                        <div class="setting-section-header">Notifications</div>
                        <div class="setting-section-content">
                            <div class="setting-group">
                                <label for="notifSound">Sound:</label>
                                <input type="checkbox" id="notifSound" checked>
                            </div>
                            <div class="setting-group">
                                <label for="notifVolume">Volume:</label>
                                <input type="range" id="notifVolume" min="0" max="100" value="30">
                                <span id="notifVolumeValue">30%</span>
                            </div>
                            <div class="setting-group">
                                <label for="notifDesktop">Desktop Alerts:</label>
                                <input type="checkbox" id="notifDesktop" checked>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section" data-section="display">
                        <div class="setting-section-header">Display</div>
                        <div class="setting-section-content">
                            <div class="setting-group">
                                <label for="showTokenStats">Token Stats:</label>
                                <input type="checkbox" id="showTokenStats" checked>
                            </div>
                        </div>
                    </div>

                    <div class="setting-section" data-section="advanced">
                        <div class="setting-section-header">Advanced</div>
                        <div class="setting-section-content">
                            <div class="setting-group setting-group--warning">
                                <label for="dangerousMode">Autonomous Mode:</label>
                                <input type="checkbox" id="dangerousMode">
                                <small class="setting-warning">Skips all permission prompts. Commands run without confirmation. Only use in fully trusted environments.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="resetSettingsBtn">Reset to Defaults</button>
                    <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
                    <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>

        <div class="plan-modal" id="planModal" role="dialog" aria-modal="true" aria-label="Claude's Plan">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>
                        <span class="icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="3" width="16" height="18" rx="2"/>
                                <line x1="8" y1="7" x2="16" y2="7"/>
                            </svg>
                        </span>
                        Claude's Plan
                    </h2>
                    <button class="close-btn" id="closePlanBtn" title="Close" aria-label="Close plan">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="plan-status" id="planStatus">
                        <span class="plan-status-indicator"></span>
                        <span class="plan-status-text">Plan Mode Active</span>
                    </div>
                    <div class="plan-content" id="planContent">
                        <!-- Plan will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="acceptPlanBtn">
                        <span class="icon" aria-hidden="true">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </span>
                        Accept Plan
                    </button>
                    <button class="btn btn-danger" id="rejectPlanBtn">
                        <span class="icon" aria-hidden="true">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </span>
                        Reject Plan
                    </button>
                </div>
            </div>
        </div>

        <div class="shortcuts-modal" id="shortcutsModal" role="dialog" aria-modal="true" aria-label="Keyboard Shortcuts">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Keyboard Shortcuts</h2>
                    <button class="close-btn" id="closeShortcutsBtn" aria-label="Close shortcuts">&times;</button>
                </div>
                <div class="modal-body">
                    <table class="shortcuts-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Shortcut</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>General</td>
                                <td><kbd>Ctrl</kbd> + <kbd>K</kbd></td>
                                <td>Command Palette</td>
                            </tr>
                            <tr>
                                <td>Sessions</td>
                                <td><kbd>Ctrl</kbd> + <kbd>T</kbd></td>
                                <td>New Session</td>
                            </tr>
                            <tr>
                                <td>Navigation</td>
                                <td><kbd>Ctrl</kbd> + <kbd>B</kbd></td>
                                <td>Toggle File Browser</td>
                            </tr>
                            <tr>
                                <td>Navigation</td>
                                <td><kbd>Ctrl</kbd> + <kbd>F</kbd></td>
                                <td>Search Terminal</td>
                            </tr>
                            <tr>
                                <td>Navigation</td>
                                <td><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>O</kbd></td>
                                <td>Open File by Path</td>
                            </tr>
                            <tr>
                                <td>Tools</td>
                                <td><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>V</kbd></td>
                                <td>VS Code Tunnel</td>
                            </tr>
                            <tr>
                                <td>Tools</td>
                                <td><kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>M</kbd></td>
                                <td>Voice Input</td>
                            </tr>
                            <tr>
                                <td>Terminal</td>
                                <td><kbd>Ctrl</kbd> + <kbd>C</kbd></td>
                                <td>Copy (with selection) / SIGINT</td>
                            </tr>
                            <tr>
                                <td>Terminal</td>
                                <td><kbd>Ctrl</kbd> + <kbd>V</kbd></td>
                                <td>Paste</td>
                            </tr>
                            <tr>
                                <td>Terminal</td>
                                <td><kbd>Escape</kbd></td>
                                <td>Cancel voice / Close search</td>
                            </tr>
                            <tr>
                                <td>Help</td>
                                <td><kbd>?</kbd></td>
                                <td>Show this dialog</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="session-modal" id="newSessionModal" role="dialog" aria-modal="true" aria-label="Create New Session">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Session</h2>
                    <button class="close-btn" id="closeNewSessionBtn" aria-label="Close new session dialog">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="sessionName">Session Name:</label>
                        <input type="text" id="sessionName" placeholder="Enter session name (optional)">
                    </div>
                    <div class="form-group">
                        <label for="sessionWorkingDir">Working Directory:</label>
                        <input type="text" id="sessionWorkingDir" placeholder="Leave empty to use current directory">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelNewSessionBtn">Cancel</button>
                    <button class="btn btn-primary" id="createSessionBtn">Create Session</button>
                </div>
            </div>
        </div>

        <div class="folder-browser-modal" id="folderBrowserModal" role="dialog" aria-modal="true" aria-label="Select Working Directory">
            <div class="modal-content folder-browser-content">
                <div class="modal-header">
                    <h2>Select Working Directory</h2>
                </div>
                <div class="folder-browser-body">
                    <div class="folder-path-bar">
                        <button class="btn-icon" id="folderUpBtn" title="Go to parent directory">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button class="btn-icon" id="folderHomeBtn" title="Go to home directory">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                        </button>
                        <input type="text" class="folder-path-input" id="currentPathInput" readonly>
                        <button class="btn-icon" id="createFolderBtn" title="Create new folder">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                <line x1="12" y1="11" x2="12" y2="17"/>
                                <line x1="9" y1="14" x2="15" y2="14"/>
                            </svg>
                        </button>
                    </div>
                    <div class="folder-create-bar" id="folderCreateBar" style="display: none;">
                        <input type="text" class="folder-name-input" id="newFolderNameInput" placeholder="Enter folder name...">
                        <button class="btn btn-primary btn-small" id="confirmCreateFolderBtn">Create</button>
                        <button class="btn btn-secondary btn-small" id="cancelCreateFolderBtn">Cancel</button>
                    </div>
                    <div class="folder-list-container">
                        <div class="folder-list" id="folderList">
                            <!-- Folders will be dynamically added here -->
                        </div>
                    </div>
                    <div class="folder-browser-footer">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showHiddenFolders">
                            Show hidden folders
                        </label>
                        <div class="folder-browser-buttons">
                            <button class="btn btn-secondary" id="cancelFolderBtn">Cancel</button>
                            <button class="btn btn-primary" id="selectFolderBtn">Select This Folder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Sessions Modal -->
    <div class="session-modal" id="mobileSessionsModal" role="dialog" aria-modal="true" aria-label="Sessions">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sessions</h2>
                <button class="modal-close" id="closeMobileSessionsModal" aria-label="Close sessions">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mobileSessionList" class="session-list">
                    <!-- Sessions will be dynamically added here -->
                </div>
                <button class="btn btn-primary" id="newSessionBtnMobile" style="width: 100%; margin-top: 10px;">New Session</button>
            </div>
        </div>
    </div>


    <script type="module" src="https://unpkg.com/ninja-keys?module"></script>
    <script src="clipboard-handler.js"></script>
    <script src="image-handler.js"></script>
    <script src="auth.js"></script>
    <script src="plan-detector.js"></script>
    <script src="session-manager.js"></script>
    <script src="splits.js"></script>
    <script src="icons.js"></script>
    <script src="file-browser.js"></script>
    <script src="file-editor.js"></script>
    <script src="vscode-tunnel.js"></script>
    <script src="app-tunnel.js"></script>
    <script src="voice-handler.js"></script>
    <script src="command-palette.js"></script>
    <script src="app.js"></script>
    <ninja-keys class="dark" id="commandPalette" hideBreadcrumbs></ninja-keys>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Show non-blocking update banner
                                    const banner = document.createElement('div');
                                    banner.className = 'sw-update-banner';
                                    banner.innerHTML = `
                                        <span>A new version is available.</span>
                                        <button class="btn btn-primary btn-small" id="swUpdateBtn">Refresh Now</button>
                                        <button class="btn btn-secondary btn-small" id="swDismissBtn">Later</button>
                                    `;
                                    document.body.appendChild(banner);

                                    document.getElementById('swUpdateBtn').addEventListener('click', () => {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    });
                                    document.getElementById('swDismissBtn').addEventListener('click', () => {
                                        banner.remove();
                                    });
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
        
        // Handle app install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            // Create install button if it doesn't exist
            if (!document.getElementById('installBtn')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'installBtn';
                installBtn.className = 'install-btn';
                installBtn.innerHTML = '<span class="icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 21h14"/></svg></span> Install App';
                
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to install prompt: ${outcome}`);
                        deferredPrompt = null;
                        installBtn.remove();
                    }
                });
                
                document.body.appendChild(installBtn);
            }
        });
        
        // Handle successful installation
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.remove();
            }
        });
    </script>
</body>
</html>
